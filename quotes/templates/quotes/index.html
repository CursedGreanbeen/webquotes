{% extends 'quotes/base.html' %}

{% block content %}
<h1>Random Quote</h1>

{% if random_quote %}
	<div class="quote">
		<p>"{{ random_quote.text }}"</p>
		<p>- Source: {{ random_quote.source.name }}</p>
	</div>
{% else %}
	<p>No quotes to show yet...</p>
{% endif %}

	<div class="stats">
		<p>Views: {{ random_quote.views}}</p>
		<button 
			class="like-button" data-quote-id="{{ random_quote.id }}">
			Like <span id="likes-{{ random_quote.id }}">{{ random_quote.likes }}</span>
		</button>
		
		<button 
			class="dislike-button" data-quote-id="{{ random_quote.id }}">
			Dislike <span id="dislikes-{{ random_quote.id }}">{{ random_quote.dislikes }}</span>
		</button>

    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.querySelectorAll('.like-button').forEach(button => {
        button.addEventListener('click', function() {
            const quoteId = this.getAttribute('data-quote-id');
            sendVote(quoteId, 'like');
        });
    });
    
    document.querySelectorAll('.dislike-button').forEach(button => {
        button.addEventListener('click', function() {
            const quoteId = this.getAttribute('data-quote-id');
            sendVote(quoteId, 'dislike');
        });
    });
    
    function getCsrfToken() {
        const cookieValue = document.cookie
            .split('; ')
            .find(row => row.startsWith('csrftoken='))
            ?.split('=')[1];
        return cookieValue;
    }
    
    function sendVote(quoteId, voteType) {
        const url = `/vote/`;
        
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCsrfToken(),
            },
            body: new URLSearchParams({
                'quote_id': quoteId,
                'vote_type': voteType
            })
        })
        .then(response => {
            return response.json();
        })
        .then(data => {
            const likesCounter = document.querySelector(`#likes-${quoteId}`);
            likesCounter.textContent = data.likes;
            const dislikesCounter = document.querySelector(`#dislikes-${quoteId}`);
            dislikesCounter.textContent = data.dislikes;
        })
        .catch(error => console.error('Error: ', error));
    }		
</script>
{% endblock %}
