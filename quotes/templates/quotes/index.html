{% extends 'quotes/base.html' %}

{% block content %}
<h1>Random Quote</h1>

{% if random_quote %}
	<div class="quote">
		<p>"{{ random_quote.text }}"</p>
		<p>- Source: {{ random_quote.source.name }}</p>
	</div>
{% else %}
	<p>No quotes to show yet...</p>
{% endif %}

	<div class="stats">
		<p>Views: {{ random_quote.views}}</p>
		<button 
			class="like-button" data-quote-id="{{ random_quote.id }}">
			Like <span id="likes-{{ random_quote.id }}">{{ random_quote.likes }}</span>
		</button>
		
		<button 
			class="dislike-button" data-quote-id="{{ random_quote.id }}">
			Dislike <span id="dislikes-{{ random_quote.id }}">{{ random_quote.dislikes }}</span>
		</button>
    </div>
{% endblock %}

{% block scripts %}
<script>
    document.querySelectorAll('.like-button').forEach(button => {
        button.addEventListener('click', function() {
            const quoteId = this.getAttribute('data-quote-id');
            sendVote(quoteId, 'like');
        });
    });
    
    document.querySelectorAll('.dislike-button').forEach(button => {
        button.addEventListener('click', function() {
            const quoteId = this.getAttribute('data-quote-id');
            sendVote(quoteId, 'dislike');
        });
    });
    
    function getCsrfToken() {
        const cookieValue = document.cookie
            .split('; ')
            .find(row => row.startsWith('csrftoken='))
            ?.split('=')[1];
        return cookieValue;
    }
    
	function sendVote(quoteId, voteType) {
    console.log(`Sending ${voteType} for quote ${quoteId}`);
    const url = `/vote/`;
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCsrfToken(),
        },
        body: new URLSearchParams({
            'quote_id': quoteId,
            'vote_type': voteType
        })
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.error) {
            alert(data.error);  // Показываем ошибку пользователю
            return;
        }
        // Обновляем счетчики
        const likesCounter = document.querySelector(`#likes-${quoteId}`);
        const dislikesCounter = document.querySelector(`#dislikes-${quoteId}`);
        if (likesCounter && dislikesCounter) {
            likesCounter.textContent = data.likes;
            dislikesCounter.textContent = data.dislikes;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error voting: ' + error.message);
    });
}
</script>
{% endblock %}
