{% extends 'quotes/base.html' %}

{% block content %}
<h1 style="text-align: center; color: #2C244F;">Random Quote of the Day</h1>

{% if random_quote %}
	<div class="quote-card">
		<p style="font-size: 1.25em; font-style: italic; margin: 0; color: #190F66;">"{{ random_quote.text }}"</p>
		<p style="margin: 15px 0 0 0; color: #190F66;">{{ random_quote.author.name }} â€” {{ random_quote.source.name }}</p>
	</div>
{% else %}
	<p>No quotes to show yet...</p>
{% endif %}

	<div class="stats">
	<div style="display: flex; justify-content: space-between; align-items: center; margin: 30px 0;">

    <div style="display: flex; gap: 20px;">
        <button 
            class="like-button" data-quote-id="{{ random_quote.id }}"
            style="background: #4BB991; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-family: 'Cambria', serif; font-size: 16px; min-width: 120px;">
            Like <span id="likes-{{ random_quote.id }}">{{ random_quote.likes }}</span>
        </button>
        
        <button 
            class="dislike-button" data-quote-id="{{ random_quote.id }}"
            style="background: #B94B73; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-family: 'Cambria', serif; font-size: 16px; min-width: 120px;">
            Dislike <span id="dislikes-{{ random_quote.id }}">{{ random_quote.dislikes }}</span>
        </button>
    </div>
    

    <p style="font-family: 'Cambria', serif; font-size: 16px; color: #2d3436; margin: 0;">
        Views: {{ random_quote.views}}
    </p>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.querySelectorAll('.like-button').forEach(button => {
        button.addEventListener('click', function() {
            const quoteId = this.getAttribute('data-quote-id');
            sendVote(quoteId, 'like');
        });
    });
    
    document.querySelectorAll('.dislike-button').forEach(button => {
        button.addEventListener('click', function() {
            const quoteId = this.getAttribute('data-quote-id');
            sendVote(quoteId, 'dislike');
        });
    });
    
    function getCsrfToken() {
        const cookieValue = document.cookie
            .split('; ')
            .find(row => row.startsWith('csrftoken='))
            ?.split('=')[1];
        return cookieValue;
    }
    
	function sendVote(quoteId, voteType) {
    console.log(`Sending ${voteType} for quote ${quoteId}`);
    const url = `/vote/`;
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCsrfToken(),
        },
        body: new URLSearchParams({
            'quote_id': quoteId,
            'vote_type': voteType
        })
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.error) {
            alert(data.error);
            return;
        }

        const likesCounter = document.querySelector(`#likes-${quoteId}`);
        const dislikesCounter = document.querySelector(`#dislikes-${quoteId}`);
        if (likesCounter && dislikesCounter) {
            likesCounter.textContent = data.likes;
            dislikesCounter.textContent = data.dislikes;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error voting: ' + error.message);
    });
}
</script>
{% endblock %}
